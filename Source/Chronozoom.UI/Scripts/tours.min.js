var ChronoZoom;(function(n){(function(t){function d(n,t,i,r){this.url=n,this.caption=t,this.lapseTime=i,this.duration=undefined,this.text=r,this.number=0,this.elapsed=0}function h(t){return n.UrlNav.navStringToVisible(t.url,this.vc)}function g(n,r,u,e,o,s,c){function k(n){i&&window.console&&console.log("playing source: "+a.currentSrc),a.pause();try{a.currentTime=n.lapseTime+n.elapsed,i&&window.console&&console.log("audio currentTime is set to "+(n.lapseTime+n.elapsed))}catch(t){window.console&&console.error("currentTime assignment: "+t)}i&&window.console&&console.log("audio element is forced to play"),a.play()}function d(n){v&&clearTimeout(v);var t=n.duration;n.elapsed!=0&&(t=Math.max(t-n.elapsed,0)),l.currentPlace.startTime=(new Date).getTime(),i&&window.console&&console.log("transition to next bookmark will be in "+t+" seconds"),v=setTimeout(w,t*1e3)}function tt(n){if(l.tour_BookmarkStarted.length>0)for(var t=0;t<l.tour_BookmarkStarted.length;t++)l.tour_BookmarkStarted[t](l,n)}function ut(n){if(l.tour_BookmarkFinished.length>0)for(var t=0;t<l.tour_BookmarkFinished.length;t++)l.tour_BookmarkFinished[t](l,n)}function ft(){if(l.tour_TourStarted.length>0)for(var n=0;n<l.tour_TourStarted.length;n++)l.tour_TourStarted[n](l)}function et(){if(l.tour_TourFinished.length>0)for(var n=0;n<l.tour_TourFinished.length;n++)l.tour_TourFinished[n](l)}var l,a,y,v,w,it,g,nt;this.title=n,this.bookmarks=r,this.category=o,this.vc=e,this.sequenceNum=c,this.tour_BookmarkStarted=[],this.tour_BookmarkFinished=[],this.tour_TourStarted=[],this.tour_TourFinished=[];var rt=!1,p=!1,b=!1;if(!r||r.length==0)throw"Tour has no bookmarks";for(this.state="pause",this.currentPlace={type:"goto",bookmark:0},l=this,r.sort(function(n,t){return n.lapseTime-t.lapseTime}),b=!1,y=1;y<r.length;y++)r[y-1].duration=r[y].lapseTime-r[y-1].lapseTime,r[y-1].number=y;r[r.length-1].duration=10,r[r.length-1].number=r.length,w=function(n){l.bookmarks[l.currentPlace.bookmark].elapsed=0,l.currentPlace.bookmark!=l.bookmarks.length-1||n?it(n):(l.state="pause",l.currentPlace={type:"goto",bookmark:0},et())},this.toggleAudio=function(n){p=n?!0:!1},this.ReinitializeAudio=function(){var u,n,t;for(a&&a.pause(),a=undefined,rt=!1,a=document.createElement("audio"),a.addEventListener("loadedmetadata",function(){a.duration!=Infinity&&(r[r.length-1].duration=a.duration-r[r.length-1].lapseTime),i&&window.console&&console.log("Tour "+l.title+" metadata loaded (readystate 1)")}),a.addEventListener("canplaythrough",function(){l.isAudioLoaded=!0,i&&window.console&&console.log("Tour "+l.title+" readystate 4")}),a.addEventListener("progress",function(){a.buffered.length>0&&i&&window.console&&console.log("Tour "+l.title+" downloaded "+a.buffered.end(a.buffered.length-1)/a.duration)}),a.controls=!1,a.autoplay=!1,a.loop=!1,a.volume=1,a.preload="none",u=s.substring(0,s.length-3),n=0;n<toursAudioFormats.length;n++)t=document.createElement("Source"),t.setAttribute("src",u+toursAudioFormats[n].ext),toursAudioFormats[n].type&&t.setAttribute("type",toursAudioFormats[n].type),a.appendChild(t);a.load(),i&&window.console&&console.log("Loading of tour "+l.title+" is queued")},it=function(n){var t=l.currentPlace.bookmark,f=t,r;t=n?Math.max(0,t-1):Math.min(l.bookmarks.length-1,t+1),ut(f),l.currentPlace={type:"goto",bookmark:t},r=l.bookmarks[l.currentPlace.bookmark],t!=0&&(tt(r),p&&l.state==="play"&&l.isAudioLoaded==!0&&k(r)),l.state!="pause"&&l.isAudioLoaded==!0&&d(r),i&&window.console&&console.log("Transitioning to the bm index "+t),l.currentPlace.animationID=u(h(r),g,nt,r.url)},g=function(n){var r,u;l.currentPlace&&l.currentPlace.animationID!=undefined&&l.currentPlace.animationID==n&&(r=getURL(),typeof r.hash.params=="undefined"&&(r.hash.params=[]),r.hash.params.tour=t.tour.sequenceNum,hashHandle=!1,setURL(r),i&&window.console&&console.log("reached the bookmark index "+l.currentPlace.bookmark),l.currentPlace={type:"bookmark",bookmark:l.currentPlace.bookmark},l.currentPlace.bookmark==0&&(u=l.bookmarks[l.currentPlace.bookmark],tt(u),l.state!="pause"&&(l.isAudioLoaded!=!0?f():(d(u),p&&k(u)))))},nt=function(n){l.currentPlace&&l.currentPlace.animationID!=undefined&&l.currentPlace.animationID==n&&(l.pause(),i&&window.console&&console.log("tour interrupted by user during transition"))},this.play=function(){var f,n,o,r;this.state==="pause"&&(i&&window.console&&console.log("tour playback activated"),this.state="play",f=e.virtualCanvas("getViewport").visible,this.currentPlace=this.currentPlace!=null&&this.currentPlace.bookmark!=null&&compareVisibles(f,h(this.bookmarks[this.currentPlace.bookmark]))?{type:"bookmark",bookmark:this.currentPlace.bookmark}:{type:"goto",bookmark:this.currentPlace.bookmark},n=this.bookmarks[this.currentPlace.bookmark],o=this.currentPlace.bookmark==0&&this.currentPlace.type=="goto",(this.currentPlace.type=="bookmark"||this.currentPlace.bookmark!=0)&&(tt(n),this.isAudioLoaded==!0&&(d(n),p&&k(n))),this.currentPlace.animationID=u(h(n),g,nt,n.url),this.currentPlace.bookmark===0&&o&&ft(),r=getURL(),typeof r.hash.params=="undefined"&&(r.hash.params=[]),typeof r.hash.params.tour=="undefined"&&(r.hash.params.tour=t.tour.sequenceNum,hashHandle=!1,setURL(r)))},this.pause=function(){if(this.state==="play"){i&&window.console&&console.log("tour playback paused"),p&&b&&(b=!1),v&&(clearTimeout(v),v=undefined),this.state="pause",p&&(a.pause(),i&&window.console&&console.log("audio element is forced to pause"));var n=this.bookmarks[this.currentPlace.bookmark];this.currentPlace.startTime&&(n.elapsed+=((new Date).getTime()-this.currentPlace.startTime)/1e3)}},this.next=function(){l.currentPlace.bookmark!=r.length-1&&(this.state==="play"&&(v&&clearTimeout(v),v=undefined),w(!1))},this.prev=function(){l.currentPlace.bookmark!=0&&(this.state==="play"&&(v&&clearTimeout(v),v=undefined),w(!0))},this.getBookmark=function(){return this.bookmarks[this.currentPlace.bookmark]}}function v(n,i){var u,r;if(n!=undefined){for(u=document.getElementById("tour_control"),u.style.display="block",t.tour=n,t.tour.tour_TourFinished.push(function(n){b(n),f(),c()}),t.tour.toggleAudio(i),r=0;r<t.tour.bookmarks.length;r++)t.tour.bookmarks[r].elapsed=0;t.tour.currentPlace.bookmark=0,i==!0&&(t.tour.ReinitializeAudio(),t.tour.isAudioLoaded=!0),p()}}function y(){f(),isTourPlayRequested=!1;var n=document.getElementById("tour_control");n.style.display="none",t.tour&&(c(),$("#bookmarks .header").html(""),t.tour.audio&&(t.tour.audio=undefined)),t.tour=undefined}function f(){t.tour!=undefined&&($("#tour_playpause").attr("src","Images/tour_play_off.jpg"),t.tour.pause(),controller.stopAnimation(),a=undefined,l=undefined)}function p(){$("#tour_playpause").attr("src","Images/tour_pause_off.jpg"),t.tour.play()}function w(){var e=$("#tours-content"),u,o,r,i,f,h;for(t.tours.sort(function(n,t){return n.sequenceNum-t.sequenceNum}),u=null,r=0;r<t.tours.length;r++)i=t.tours[r],i.tour_BookmarkStarted.push(function(n,t){nt(n,t)}),i.tour_BookmarkFinished.push(function(n){b(n)}),i.category!==u&&(f=$('<div class="category">'+i.category+"<\/div>").appendTo(e),h=$('<img src="Images/collapse-down.png" class="collapseButton" />').appendTo(f),r==0&&(f.removeClass("category").addClass("categorySelected"),h[0].src="Images/collapse-up.png"),o=$('<div class="itemContainer"><\/div>').appendTo(e),u=i.category),$('<div class="item" tour="'+r+'">'+i.title+"<\/div>").appendTo(o).click(function(){y(),$("#tours").hide("slide",{},"slow"),n.Common.toggleOffImage("e_index"),t.isTourWindowVisible=!1;var i=t.tours[this.getAttribute("tour")];v(i,s),$(".touritem-selected").removeClass("touritem-selected","slow"),$(this).addClass("touritem-selected","slow")});$("#tours-content").accordion({fillSpace:!1,collapsible:!0,autoHeight:!1}),$("#tours-content").bind("accordionchangestart",function(n,t){var i;t.newHeader&&(t.newHeader.removeClass("category"),t.newHeader.addClass("categorySelected"),i=$(".collapseButton",t.newHeader)[0],i&&(i.src="Images/collapse-up.png")),t.oldHeader&&(t.oldHeader.removeClass("categorySelected"),t.oldHeader.addClass("category"),i=$(".collapseButton",t.oldHeader)[0],i&&(i.src="Images/collapse-down.png"))})}function b(){u&&o&&(r&&r.stop(!0,!0),r=$("#bookmarks .slideText").hide("drop",{},"slow",function(){r=undefined}),$("#bookmarks .slideHeader").html(""),o=!1)}function nt(n,t){e||(e=!0,$("#bookmarks .slideText").html(t.text),$("#bookmarks").show("slide",{},"slow")),$("#bookmarks .header").html(n.title),$("#bookmarks .slideHeader").html(t.caption),$("#bookmarks .slideFooter").html(t.number+"/"+n.bookmarks.length),u?($("#bookmarks .slideText").html(t.text),o||(r&&r.stop(!0,!0),r=$("#bookmarks .slideText").show("drop",{},"slow",function(){r=undefined}),o=!0)):$("#bookmarks .slideText").html(t.text)}function c(){$("#bookmarks").hide(),e=!1}function k(){isSearchWindowVisible&&onSearchClicked(),t.isTourWindowVisible?(n.Common.toggleOffImage("tours_index"),$("#tours").hide("slide",{},"slow")):(n.Common.toggleOnImage("tours_index"),$("#tours").show("slide",{},"slow")),t.isTourWindowVisible=!t.isTourWindowVisible}function tt(n){var f,o,i,s,e,r,u;for(t.tours=[],f=0;f<n.d.length;f++)if(o=!0,i=n.d[f],typeof i.bookmarks!="undefined"&&typeof i.AudioBlobUrl!="undefined"&&i.AudioBlobUrl!=undefined&&i.AudioBlobUrl!=null&&typeof i.Category!="undefined"&&typeof i.Name!="undefined"&&typeof i.Sequence!="undefined"){for(s=[],e=0;e<i.bookmarks.length;e++){if(r=i.bookmarks[e],typeof r.Description=="undefined"||typeof r.LapseTime=="undefined"||typeof r.Name=="undefined"||typeof r.URL=="undefined"){o=!1;break}u=r.URL,u.indexOf("#")!=-1&&(u=u.substring(u.indexOf("#")+1)),s.push(new d(u,r.Name,r.LapseTime,r.Description))}o&&t.tours.push(new g(i.Name,s,it,$("#vc"),i.Category,i.AudioBlobUrl,i.Sequence))}}function it(n,i,r,u){l=i,a=r,t.pauseTourAtAnyAnimation=!1;var f=setVisible(n);return f&&u&&(setNavigationStringTo={bookmark:u,id:f}),f}function rt(){var n=getURL();typeof n.hash.params!="undefined"&&n.hash.params.tour>t.tours.length||typeof n.hash.params!="undefined"&&typeof n.hash.params.tour!="undefined"&&(t.tours==null&&w(),t.isTourWindowVisible&&k(),t.tour=t.tours[n.hash.params.tour-1],$(".touritem-selected").removeClass("touritem-selected","slow"),v(t.tour,!0),t.tour.audio&&(t.tour.audio.pause(),t.tour.audio.preload="none"),f())}var l,a,r,i;t.isTourWindowVisible=!1;var e=!1,u=!0,o=!0,s=!0;t.tours,t.tour,t.pauseTourAtAnyAnimation=!1,i=!1,t.tourPause=f,t.initializeToursContent=w,t.onTourClicked=k,t.parseTours=tt,t.loadTourFromURL=rt})(n.Tours||(n.Tours={}));var t=n.Tours})(ChronoZoom||(ChronoZoom={}))